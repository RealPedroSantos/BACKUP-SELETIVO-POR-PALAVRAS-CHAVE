# ======================= TOOLKIT (v3.9) =======================
# Menu principal reduzido:
# [7] Corrigir Pesquisa/Menu Iniciar
# [9] Win11 Repair - Menu completo
# [0] Sair
# Execute no PowerShell como Administrador.

[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$ErrorActionPreference = 'Stop'

# ---------------- Utilidades ----------------
function Info([string]$m){ Write-Host "[i]  $m"  -ForegroundColor Cyan }
function Ok  ([string]$m){ Write-Host "[OK] $m" -ForegroundColor Green }
function Warn([string]$m){ Write-Host "[!]  $m"  -ForegroundColor Yellow }
function Err ([string]$m){ Write-Host "[x]  $m"  -ForegroundColor Red }

function Test-IsAdmin {
  $id = [Security.Principal.WindowsIdentity]::GetCurrent()
  $p  = New-Object Security.Principal.WindowsPrincipal($id)
  return $p.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

function AskYN([string]$q){
  ($ans = Read-Host "$q (S/N)") -match '^[sS]'
}

function Pause-Enter([string]$msg = "Pressione Enter para continuar..."){
  Info $msg
  [void][System.Console]::ReadLine()
}

# ==================== OPÇÃO [7] — CORRIGIR PESQUISA / MENU INICIAR ====================
function ShowHeaderFixSearch{
  Clear-Host
  Write-Host "========== CORRECAO DA PESQUISA / MENU INICIAR (Windows Search) ==========" -ForegroundColor Cyan
}

function Run-FixSearch {
  ShowHeaderFixSearch

  if(-not (Test-IsAdmin)){
    Err "Rode como Administrador."
    Pause-Enter
    return
  }

  if(-not (AskYN "Tentar corrigir a busca do Windows neste PC?")){
    Warn "Cancelado."
    Pause-Enter
    return
  }

  $errors = 0

  try{
    Info "Ajustando servico WSearch..."
    Set-Service -Name WSearch -StartupType Automatic -ErrorAction Stop
    Restart-Service WSearch -ErrorAction Stop
    Ok "WSearch OK."
  } catch {
    $errors++
    Err ("WSearch falhou: {0}" -f $_.Exception.Message)
  }

  $packages = @('*StartMenuExperienceHost*','*ShellExperienceHost*','*Windows.Search*')
  foreach($pattern in $packages){
    try{
      Info ("Re-registrando: {0}" -f $pattern)
      $pkg = Get-AppxPackage -AllUsers $pattern -ErrorAction SilentlyContinue
      if(-not $pkg){ Warn "Nao encontrado: $pattern"; continue }
      $pkg | ForEach-Object {
        $manifest = Join-Path $_.InstallLocation 'AppXManifest.xml'
        Add-AppxPackage -DisableDevelopmentMode -Register $manifest -ErrorAction Stop
      }
      Ok ("OK: {0}" -f $pattern)
    } catch {
      $errors++
      Err ("Falha {0}: {1}" -f $pattern, $_.Exception.Message)
    }
  }

  try{
    $ctf = Join-Path (Join-Path $env:SystemRoot 'System32') 'ctfmon.exe'
    if(Test-Path $ctf){ Start-Process $ctf; Ok "ctfmon OK." } else { Warn "ctfmon nao encontrado." }
  } catch {
    $errors++
    Err ("ctfmon falhou: {0}" -f $_.Exception.Message)
  }

  if(AskYN "Executar tambem sfc scannow? (pode demorar)"){
    try{
      Info "Rodando SFC..."
      sfc /scannow
      Ok "SFC OK."
    } catch {
      $errors++
      Err ("SFC falhou: {0}" -f $_.Exception.Message)
    }
  }

  if($errors -gt 0){
    Warn ("Concluido com {0} falha(s). Recomendo reiniciar o PC." -f $errors)
  } else {
    Ok "Concluido. Recomendo reiniciar o PC."
  }

  Pause-Enter
}

# ==================== OPÇÃO [9] — WIN11 REPAIR (MENU INTERNO) ====================
function Run-Win11Repair {
  Clear-Host
  Write-Host "===================== WIN11 REPARA TUDO =====================" -ForegroundColor Cyan
  Write-Host "Cria ponto de restauracao, gera log na Area de Trabalho e oferece menu de reparos." -ForegroundColor Yellow
  Write-Host "=============================================================" -ForegroundColor Cyan

  if(-not (Test-IsAdmin)){
    Err "Rode como Administrador."
    Pause-Enter
    return
  }

  try { Set-ExecutionPolicy -Scope Process Bypass -Force } catch {}

  $logPath = Join-Path ([Environment]::GetFolderPath('Desktop')) ("Win11_Repair_Log_{0:yyyyMMdd_HHmmss}.txt" -f (Get-Date))
  $transcriptStarted = $false
  try { Start-Transcript -Path $logPath -Append | Out-Null; $transcriptStarted = $true } catch { Warn "Nao consegui iniciar o log (Start-Transcript). Continuando sem log." }

  function New-RestorePointSafe {
    try {
      Info "Criando ponto de restauracao do sistema..."
      Checkpoint-Computer -Description "Win11_Repair_$(Get-Date -Format yyyyMMdd_HHmmss)" -RestorePointType "MODIFY_SETTINGS"
      Ok "Ponto de restauracao criado."
    } catch {
      Warn "Nao foi possivel criar ponto de restauracao (talvez desativado). Continuando..."
    }
  }

  function Fix-SFC {
    Info "Executando verificacao de integridade (SFC)..."
    sfc /scannow
    Ok "SFC finalizado."
  }

  function Fix-DISM {
    Info "Reparando imagem do Windows (DISM RestoreHealth)... pode demorar."
    DISM /Online /Cleanup-Image /RestoreHealth
    Ok "DISM finalizado."
  }

  function Reset-WindowsUpdate {
    Info "Resetando componentes do Windows Update..."
    $services = "wuauserv","bits","cryptsvc","msiserver"
    foreach($svc in $services){ sc.exe stop $svc | Out-Null 2>&1 }
    Start-Sleep -Seconds 2

    $sd = Join-Path $env:SystemRoot 'SoftwareDistribution'
    $cr = Join-Path (Join-Path $env:SystemRoot 'System32') 'catroot2'

    if(Test-Path $sd){ Rename-Item $sd ($sd + ".bak_" + (Get-Date -Format yyyyMMddHHmmss)) -ErrorAction SilentlyContinue }
    if(Test-Path $cr){ Rename-Item $cr ($cr + ".bak_" + (Get-Date -Format yyyyMMddHHmmss)) -ErrorAction SilentlyContinue }

    $dlls = @("atl.dll","urlmon.dll","mshtml.dll","jscript.dll","wuaueng.dll","wuapi.dll","wucltux.dll","wups.dll","wups2.dll","wuwebv.dll","qmgr.dll","qmgrprxy.dll")
    foreach($d in $dlls){
      try {
        $dllPath = Join-Path (Join-Path $env:SystemRoot 'System32') $d
        regsvr32.exe /s $dllPath
      } catch {}
    }

    foreach($svc in $services){ sc.exe start $svc | Out-Null 2>&1 }
    Ok "Windows Update resetado."
  }

  function Fix-StoreUWP {
    Info "Limpando cache da Microsoft Store (wsreset)..."
    try { Start-Process -FilePath "wsreset.exe" -Wait } catch {}
    Ok "WSReset concluido."

    Info "Re-registrando apps UWP (usuario atual)..."
    Get-AppxPackage | ForEach-Object {
      try {
        $manifest = Join-Path $_.InstallLocation 'AppxManifest.xml'
        Add-AppxPackage -DisableDevelopmentMode -Register $manifest -ErrorAction Stop
      } catch {}
    }
    Ok "Re-registro UWP concluido."
  }

  function Fix-Network {
    Info "Reset de rede (Winsock IP) e DNS..."
    ipconfig /flushdns | Out-Null
    netsh winsock reset | Out-Null
    netsh int ip reset | Out-Null
    Ok "Rede resetada. Reinicie o PC se necessario."
  }

  function Rebuild-IconThumbCache {
    Info "Reconstruindo cache de icones e miniaturas..."
    Stop-Process -Name explorer -Force -ErrorAction SilentlyContinue

    $explorerDir = Join-Path (Join-Path (Join-Path (Join-Path $env:LOCALAPPDATA 'Microsoft') 'Windows') 'Explorer') ''
    $thumbPattern = Join-Path $explorerDir 'thumbcache_*'
    $iconDb = Join-Path $env:LOCALAPPDATA 'IconCache.db'
    $iconPattern = Join-Path $explorerDir 'iconcache*'

    foreach($p in @($thumbPattern,$iconDb,$iconPattern)){
      Get-ChildItem $p -Force -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
    }

    Start-Process explorer.exe
    Ok "Caches reconstruidos."
  }

  function Clean-Temp {
    Info "Limpando arquivos temporarios (usuario e sistema)..."
    $paths = @($env:TEMP,(Join-Path $env:WINDIR 'Temp'))
    foreach($p in $paths){
      if(Test-Path $p){
        Get-ChildItem -Path $p -Recurse -Force -ErrorAction SilentlyContinue |
          Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
      }
    }
    Ok "Temporarios limpos."
  }

  function Check-Drive {
    Info "Checando disco do sistema (chkdsk scan)..."
    chkdsk C: /scan
    Ok "Verificacao online concluida."
    Warn "Para correcao completa: chkdsk C: /f (vai agendar e pedir reboot)."
  }

  function Fix-CommonServices {
    Info "Garantindo servicos essenciais em Automatico (quando existirem)..."
    $toAuto = @("wuauserv","bits","cryptsvc","dhcp","dnscache","eventlog","trkwks")
    foreach($svc in $toAuto){
      try { Set-Service -Name $svc -StartupType Automatic -ErrorAction Stop } catch {}
    }
    Ok "Servicos ajustados (quando existentes)."
  }

  function Reboot-IfWanted {
    $ans = Read-Host "Deseja reiniciar agora? (S/N)"
    if($ans -match '^[sS]'){
      Info "Reiniciando..."
      if($transcriptStarted){ try { Stop-Transcript | Out-Null } catch {} }
      Restart-Computer
    }
  }

  function Run-All {
    New-RestorePointSafe
    Fix-SFC
    Fix-DISM
    Reset-WindowsUpdate
    Fix-StoreUWP
    Fix-Network
    Rebuild-IconThumbCache
    Clean-Temp
    Check-Drive
    Fix-CommonServices
    Ok "Pacotao concluido!"
    Info ("Log salvo em: {0}" -f $logPath)
    Reboot-IfWanted
  }

  function Show-MenuRepair {
    Clear-Host
    Write-Host "===================== WIN11 REPAIR - MENU =====================" -ForegroundColor Cyan
    Write-Host "[1] Executar TUDO (recomendado)" -ForegroundColor Green
    Write-Host "[2] SFC (verificar arquivos do sistema)"
    Write-Host "[3] DISM (reparar imagem do Windows)"
    Write-Host "[4] Reset Windows Update"
    Write-Host "[5] Repair Microsoft Store UWP"
    Write-Host "[6] Reset de Rede (Winsock IP) e Flush DNS"
    Write-Host "[7] Reconstruir cache de icones miniaturas"
    Write-Host "[8] Limpar arquivos temporarios"
    Write-Host "[9] Checar disco (CHDSK scan)"
    Write-Host "[10] Ajustar servicos comuns"
    Write-Host "[0] Voltar"
    Write-Host "==============================================================="
  }

  do {
    Show-MenuRepair
    $opt = Read-Host "Escolha uma opcao"
    try {
      switch($opt){
        '1'  { Run-All }
        '2'  { New-RestorePointSafe; Fix-SFC; Reboot-IfWanted }
        '3'  { New-RestorePointSafe; Fix-DISM; Reboot-IfWanted }
        '4'  { New-RestorePointSafe; Reset-WindowsUpdate; Reboot-IfWanted }
        '5'  { New-RestorePointSafe; Fix-StoreUWP; Reboot-IfWanted }
        '6'  { New-RestorePointSafe; Fix-Network; Reboot-IfWanted }
        '7'  { New-RestorePointSafe; Rebuild-IconThumbCache }
        '8'  { Clean-Temp }
        '9'  { Check-Drive }
        '10' { Fix-CommonServices }
        '0'  { break }
        default { Warn "Opcao invalida." }
      }
    } catch {
      Err ("Erro: {0}" -f $_.Exception.Message)
    }

    if($opt -ne '0'){
      Pause-Enter "Pressione Enter pra voltar ao menu do Win11 Repair..."
    }
  } while ($true)

  if($transcriptStarted){ try { Stop-Transcript | Out-Null } catch {} }
  Ok ("Win11 Repair finalizado. Log em: {0}" -f $logPath)
  Pause-Enter
}

# ---------------- MENU PRINCIPAL (reduzido) ----------------
function ShowHeaderMain{
  Clear-Host
  Write-Host "================ TOOLKIT (v3.9) ================" -ForegroundColor Cyan
  Write-Host "[7] Corrigir pesquisa do Windows (Search Menu Iniciar)" -ForegroundColor Cyan
  Write-Host "[9] Win11 Repair - Menu" -ForegroundColor Green
  Write-Host "[0] Sair" -ForegroundColor White
  Write-Host "================================================" -ForegroundColor Cyan
}

# ---------------- Loop principal ----------------
do {
  try {
    ShowHeaderMain
    $opt = Read-Host "Escolha uma opcao"
    switch($opt){
      '7' { Run-FixSearch }
      '9' { Run-Win11Repair }
      '0' { Info "Saindo..."; Start-Sleep -Milliseconds 120; exit 0 }
      default { Warn "Opcao invalida."; Pause-Enter }
    }
  } catch {
    Err ("Erro: {0}" -f $_.Exception.Message)
    Pause-Enter
  }
} while ($true)
